# Feature Log: 2026-02-13

## Summary

1. **Terminal View Modes** - Added persisted `alt-mode`/`text-buffer` view modes with runtime switching via `/view` and `/settings`.
2. **Help and Startup UX** - Added `/help`, moved shortcut list out of startup header, and rendered help content in a bordered panel.
3. **Bash Input Safety Toggle** - Added `terminal.enableBashMode` (default `false`) and gated `!command` execution behind settings.
4. **Removed Interactive `!!` Mode** - Removed the editor-level `!!` path and related docs references.
5. **UI Flattening and Outline Semantics** - Removed filled background boxes from core chat/tool surfaces and shifted status meaning to outline colors.
6. **Repository Documentation Refresh** - Added a root `ca-cli/README.md` summarizing workspace usage and session changes.

---

## 1. Terminal View Modes

### Overview
Added a terminal rendering mode abstraction for interactive TUI usage: `alt-mode` (alternate screen) and `text-buffer` (normal terminal buffer). The setting is persisted, defaults to `alt-mode`, and is switchable at runtime via a new `/view` selector and `/settings`.

### Files Created

| File | Purpose |
|------|---------|
| `packages/coding-agent/src/modes/interactive/components/view-mode-selector.ts` | Selector UI for choosing `alt-mode` vs `text-buffer`. |
| `packages/tui/test/view-mode.test.ts` | TUI tests for view mode startup/switch behavior. |

### Files Modified

| File | Changes |
|------|---------|
| `packages/coding-agent/src/core/settings-manager.ts` | Added `terminal.viewMode` schema and `getViewMode`/`setViewMode`. |
| `packages/coding-agent/src/core/slash-commands.ts` | Added `/view` command metadata. |
| `packages/coding-agent/src/modes/interactive/interactive-mode.ts` | Wired startup/apply/persist/select behavior for view mode. |
| `packages/coding-agent/src/modes/interactive/components/settings-selector.ts` | Added `View mode` setting item and callback. |
| `packages/coding-agent/src/modes/interactive/components/index.ts` | Exported view mode selector component/types. |
| `packages/tui/src/terminal.ts` | Added alternate screen toggle API and process terminal implementation. |
| `packages/tui/src/tui.ts` | Added internal `TerminalViewMode` state and runtime switching. |
| `packages/tui/src/index.ts` | Exported `TerminalViewMode` type. |
| `packages/tui/test/virtual-terminal.ts` | Added alternate screen support for test terminal implementation. |

### Implementation Details

#### View Mode Data Flow

```text
settings.json (terminal.viewMode)
        │
        ▼
SettingsManager.getViewMode()
        │
        ▼
InteractiveMode syncs mode into TUI
        │
        ▼
TUI calls Terminal.setAltScreenEnabled(...)
```

#### Runtime Switching

- `/view` opens a selector with two options.
- Selection updates settings and applies immediately without restart.
- TUI forces a re-render after mode switch for clean visual transition.

### Architecture Decisions

1. **Persist mode in `terminal` settings namespace** - Keeps display/runtime toggles grouped with other terminal behavior.
2. **Support runtime apply** - Avoids restart friction and enables immediate visual feedback.
3. **Compatibility fallback in interactive mode** - Interactive layer was updated to work across differing TUI type surfaces in local dependency states.

---

## 2. Help and Startup UX

### Overview
Introduced `/help` to provide a concise shortcut reference on demand. The startup header no longer prints a large key list and now uses a minimal hint (`Use /help for shortcuts`).

### Files Modified

| File | Changes |
|------|---------|
| `packages/coding-agent/src/core/slash-commands.ts` | Added `/help` command metadata. |
| `packages/coding-agent/src/modes/interactive/interactive-mode.ts` | Added `/help` command handling, help rendering, startup header simplification. |

### Implementation Details

#### Help Rendering Style

- `/help` prints the requested key list text.
- Output is rendered in a bordered panel.
- Text color is muted gray for reduced visual noise.

---

## 3. Bash Input Safety Toggle and `!!` Removal

### Overview
Bash command entry from the editor is now opt-in via settings (`terminal.enableBashMode`, default `false`). The editor-level `!!` mode was removed to simplify behavior and reduce accidental risky execution patterns.

### Files Modified

| File | Changes |
|------|---------|
| `packages/coding-agent/src/core/settings-manager.ts` | Added `terminal.enableBashMode` and accessor/mutator methods. |
| `packages/coding-agent/src/modes/interactive/components/settings-selector.ts` | Added `Enable bash mode` setting item and callback. |
| `packages/coding-agent/src/modes/interactive/interactive-mode.ts` | Gated `!command` handling on setting; removed `!!` parsing path. |
| `packages/coding-agent/README.md` | Updated command description to reflect bash enablement and `/help`. |
| `packages/coding-agent/docs/settings.md` | Documented `terminal.enableBashMode`. |
| `packages/coding-agent/docs/extensions.md` | Removed `!!` phrasing from `user_bash` docs. |
| `packages/coding-agent/docs/session.md` | Generalized `excludeFromContext` wording. |
| `packages/coding-agent/src/core/agent-session.ts` | Removed `!!`-specific wording from comments. |

### Architecture Decisions

1. **Default-off bash mode** - Better safety baseline for new users.
2. **Single command path (`!`)** - Simpler interaction model and lower cognitive load.

---

## 4. UI Flattening and Outline Semantics

### Overview
Applied visual simplification to interactive chat surfaces: removed colored fills and emphasized outline-based status coloring. Body text in primary surfaces was shifted toward muted gray for consistency.

### Files Modified

| File | Changes |
|------|---------|
| `packages/coding-agent/src/modes/interactive/components/user-message.ts` | Removed message background fill, added muted text + neutral border. |
| `packages/coding-agent/src/modes/interactive/components/custom-message.ts` | Removed fill-based styling, used muted text and neutral borders. |
| `packages/coding-agent/src/modes/interactive/components/skill-invocation-message.ts` | Removed custom-message fill usage, switched to muted text emphasis. |
| `packages/coding-agent/src/modes/interactive/components/tool-execution.ts` | Removed tool fill backgrounds; introduced border-state semantics. |
| `packages/coding-agent/src/modes/interactive/components/bash-execution.ts` | Removed mode/fill emphasis and used status-colored borders with muted text. |
| `packages/coding-agent/src/modes/interactive/interactive-mode.ts` | Updated info/warn/error panel rendering to use explicit outline color mapping. |

### Implementation Details

#### Border Color Mapping

```text
neutral -> borderMuted (gray)
info    -> borderAccent (blue)
warning -> warning (yellow)
error   -> error (red)
```

This mapping is now used by core status/help/changelog panels and major execution surfaces.

---

## 5. Repository Documentation Refresh

### Overview
Added a root-level `README.md` in `ca-cli` with setup/build/test instructions and a summary of major changes from this session.

### Files Created

| File | Purpose |
|------|---------|
| `README.md` | Top-level workspace readme for contributors and operators. |

---

## Testing Instructions

### Build Validation

1. `pnpm --dir packages/tui build`
2. `pnpm --dir packages/coding-agent build`
3. **Expected**: TypeScript compile succeeds and coding-agent assets are copied to `dist`.

### Runtime Checks

1. Start CLI (`node packages/coding-agent/dist/cli.js`).
2. Run `/view` and switch between `alt-mode` and `text-buffer`.
3. Run `/help`.
4. Open `/settings`, verify `Enable bash mode` and `View mode` exist.
5. With bash mode disabled, type `!echo hi`.
6. **Expected**: Warning indicates bash mode is disabled.
7. Enable bash mode in `/settings`, retry `!echo hi`.
8. **Expected**: Command executes via bash path.

### Visual Checks

1. Trigger info (`/changelog`), warning, and error messages.
2. Observe user/custom/tool messages and bash outputs.
3. **Expected**:
   - No colored fill backgrounds in core surfaces.
   - Outline colors follow status mapping.
   - Body text appears muted/gray in flattened surfaces.

---

## Summary of All Changes

### New Files (5)
- `README.md`
- `packages/coding-agent/src/modes/interactive/components/view-mode-selector.ts`
- `packages/coding-agent/test/slash-commands.test.ts`
- `packages/tui/test/view-mode.test.ts`
- `note.txt`

### Modified Files (major session-related subset)
- `packages/coding-agent/README.md`
- `packages/coding-agent/docs/extensions.md`
- `packages/coding-agent/docs/session.md`
- `packages/coding-agent/docs/settings.md`
- `packages/coding-agent/src/core/agent-session.ts`
- `packages/coding-agent/src/core/settings-manager.ts`
- `packages/coding-agent/src/core/slash-commands.ts`
- `packages/coding-agent/src/modes/interactive/components/bash-execution.ts`
- `packages/coding-agent/src/modes/interactive/components/custom-message.ts`
- `packages/coding-agent/src/modes/interactive/components/index.ts`
- `packages/coding-agent/src/modes/interactive/components/settings-selector.ts`
- `packages/coding-agent/src/modes/interactive/components/skill-invocation-message.ts`
- `packages/coding-agent/src/modes/interactive/components/tool-execution.ts`
- `packages/coding-agent/src/modes/interactive/components/user-message.ts`
- `packages/coding-agent/src/modes/interactive/interactive-mode.ts`
- `packages/coding-agent/test/settings-manager.test.ts`
- `packages/tui/src/index.ts`
- `packages/tui/src/terminal.ts`
- `packages/tui/src/tui.ts`
- `packages/tui/test/virtual-terminal.ts`

### Documentation Updated
- `README.md` (root, added)
- `packages/coding-agent/README.md`
- `packages/coding-agent/docs/settings.md`
- `packages/coding-agent/docs/extensions.md`
- `packages/coding-agent/docs/session.md`

### Dependencies Added
- None.

### Commands Added
- `/view` - Runtime terminal view mode selector.
- `/help` - Quick shortcut reference panel.
