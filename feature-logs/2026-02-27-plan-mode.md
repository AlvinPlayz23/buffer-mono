# Feature Log: 2026-02-27 (Plan Mode)

## Summary
1. Added first-class work modes: `build` (default) and `plan` (toggle).
2. Added plan-mode-only tools: `question`, `plan_create`, and `implement`.
3. Added interactive UX wiring: `/plan`, `Ctrl+Tab`, and `PLAN MODE` indicator.
4. Added RPC and ACP support for work-mode switching.
5. Added ACP architecture TODO for native question-tool UI integration.

---

## Work Mode Runtime

### What was implemented
- Introduced `WorkMode = "build" | "plan"` in session runtime.
- Added `setWorkMode()` and `toggleWorkMode()` to `AgentSession`.
- Startup/default remains `build` every run.
- Mode is not persisted to settings.

### Behavior
- `build` mode: normal coding flow/tools.
- `plan` mode: planning/research flow only.

### Tool gating
- `plan` mode toolset:
  - `read`, `grep`, `find`, `ls`, `question`, `plan_create`, `implement`
- Restoring `build` mode restores the previous active build tool snapshot.

### Files
- `src/coding-agent/core/agent-session.ts`
- `src/coding-agent/core/system-prompt.ts`

---

## New Tools

## `question`
- Structured user clarification tool.
- Enforces 2-3 options.
- Supports custom answer path.
- In interactive mode, implemented via UI select + input.

File:
- `src/coding-agent/core/tools/question.ts`

## `plan_create`
- Creates Markdown plan files only (`.md`).
- Restricted to workspace-root `.buffer/`.
- Blocks path traversal and non-markdown writes.
- Workspace root resolution:
  - uses nearest git root if available,
  - otherwise falls back to current cwd.

File:
- `src/coding-agent/core/tools/plan-create.ts`

## `implement`
- Fixed 2-choice confirmation flow.
- Choices:
  - `Implement this plan now`
  - `Keep planning for now`
- If approved:
  - stops current stream
  - switches mode to `build`
  - auto-sends: `Implement this Plan`
- If deferred:
  - remains in `plan` mode

File:
- `src/coding-agent/core/tools/implement.ts`

Tool registry wiring:
- `src/coding-agent/core/tools/index.ts`

---

## Interactive Wiring

### Commands/shortcuts
- Added built-in `/plan` command (toggle on/off).
- Added app action `toggleWorkMode`.
- Bound `toggleWorkMode` to `Ctrl+Tab`.
- Kept `Shift+Tab` unchanged for thinking-level cycling.

### Visual indicator
- Shows `PLAN MODE` below editor in plan mode.
- No indicator in build mode.

### Help/hotkeys updates
- Added plan-mode toggle hints in help/hotkeys text.

Files:
- `src/coding-agent/core/slash-commands.ts`
- `src/coding-agent/core/keybindings.ts`
- `src/coding-agent/modes/interactive/interactive-mode.ts`

---

## RPC Support

### Added protocol support
- New command: `set_work_mode` with payload:
  - `{ mode: "build" | "plan" }`
- Extended `get_state` output with:
  - `workMode: "build" | "plan"`
- Added client helper:
  - `RpcClient.setWorkMode(mode)`

Files:
- `src/coding-agent/modes/rpc/rpc-types.ts`
- `src/coding-agent/modes/rpc/rpc-mode.ts`
- `src/coding-agent/modes/rpc/rpc-client.ts`

---

## ACP Support

### Adapter and bridge wiring
- Added ACP built-in `/plan` command.
- `/plan` reads current mode from RPC state and toggles it.
- ACP help text updated to include `/plan`.
- ACP RPC bridge supports forwarding `set_work_mode`.

Files:
- `src/coding-agent/modes/acp/acp/agent.ts`
- `src/coding-agent/modes/acp/pi-rpc/process.ts`

---

## Documentation/TODO

- Added ACP desktop-native question tool architecture TODO:
  - `TODO-QUESTION-TOOL.md`

---

## Validation

- Source typecheck passed:
  - `pnpm exec tsc -p tsconfig.build.json --noEmit`
- Full-repo `tsc --noEmit` still has pre-existing unrelated `test/buffer-ai` typing errors.
- Vitest execution in this sandbox hit worker spawn `EPERM` (environment restriction).
